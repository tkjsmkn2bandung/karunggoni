box: rails:4.1
dev:
  services:
    - spotify/cassandra
#    - spotify/kafka
  steps:
    - bundle-install
    - internal/watch:
        code: |
          until bundle exec rake cassandra:setup; do echo "waiting..."; sleep 5; done;
          bundle exec rspec
          rails server
        reload: false
test:
  services:
    - spotify/cassandra
  steps:
    - bundle-install
    - script:
        name: setup cassandra
        code: until bundle exec rake cassandra:setup; do sleep 5; done;
    - script:
        name: rspec
        code: bundle exec rspec

build-dev:
  steps:
    - script:
        name: move to rails dir
        code: |
              mkdir /rails
              mv $WERCKER_SOURCE_DIR/* /rails
    - bundle-install:
        cwd: /rails
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        cmd: rails server
        working-dir: /rails
        ports: 3000
        repository: $REPOSITORY
        tag: dev
